<!DOCTYPE html>
<html lang='en'>
<head>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="bootstrap3.3.7.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <meta charset='UTF-8'>
    <title>Shop</title>
</head>
<body>

<div class="buttons col-sm-2">
    <button id="show-clients" class="btn">Clients</button>
    <button id="show-products" class="btn">Products</button>
</div>

<div id="add-client-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add client</h4>
            </div>
            <div class="modal-body">
                <label> Name
                    <input id="client-name" class="form-control">
                </label>
                <label> Age
                    <input id="client-age" class="form-control" type="number">
                </label>
                <label> Purchase price
                    <input id="client-purchase-price" class="form-control" type="number">
                </label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="add-client" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>

<div id="add-product-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add product</h4>
            </div>
            <div class="modal-body">
                <label> Name
                    <input id="product-name" class="form-control">
                </label>
                <label> Type
                    <select id="product-type" name="product-type" class="form-control">

                    </select>
                </label>
                <label> Price
                    <input id="product-price" class="form-control" type="number">
                </label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="add-product" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>

<div id="change-types" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Change types</h4>
            </div>
            <div id="div-show-types" class="modal-body">
                <label> Name
                    <input id="type-name" class="form-control">
                </label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="change-types-button" class="btn">Show types</button>
                <button id="add-type" class="btn btn-primary">Add</button>
            </div>
        </div>
    </div>
</div>

<div id="display-records-div" class="col-md-6">

</div>

<script>
    function loadTypesOfProducts() {
        $.get('product_types.php', {action: 'get'})
            .then(function (response) {
                var types = JSON.parse(response).types;

                var product_type = $('#product-type');

                product_type.empty();
                for (var index in types) {
                    product_type
                        .append($('<option>', {
                            value: types[index].name,
                            text: types[index].name
                        }));
                }
            })
            .catch(function () {
                alert("Failed loading types of products");
            })

    }

    $('#add-type').click(function () {
        var type = $("#type-name").val();
        var typePattern = /^[a-ząęóśłńćżź]{3,25}$/i;
        if (typePattern.test(type)) {
            $.post('product_types.php', {
                action: 'add',
                type: type
            })
                .then(function () {
                    loadTypesOfProducts();
                    showTypes();
                    $('#div-show-types').removeClass('has-error');
                })
                .catch(function () {
                    alert('Error adding new type');
                })
        }
        else {
            $('#div-show-types').addClass('has-error');
        }
    });

    $("#add-client").click(function () {
        var name = $("#client-name").val();
        var age = $("#client-age").val();
        var purchase_price = $("#client-purchase-price").val();
        $.post('client.php', {
            action: 'client',
            name: name,
            age: age,
            purchase_price: purchase_price
        })
            .then(function () {
                $('#add-client-modal').modal('hide');
                showClients();
            })
            .catch(function () {
                alert('Error');
            })
    });

    $("#add-product").click(function () {
        var name = $("#product-name").val();
        var type = $("#product-type").val();
        var price = $("#product-price").val();
        $.post('product.php', {
            action: 'product',
            name: name,
            type: type,
            price: price
        })
            .then(function (response) {
                alert(response);
            })
            .catch(function () {
                alert('Error');
            })
    });

    $("#show-clients").click(function () {
        showClients();
    });

    function showTypes() {
        $.get('product_types.php', {
            action: 'get'
        })
            .then(function (response) {
                var types = JSON.parse(response).types;
                console.log(types);

                var productTypes = $('#div-show-types');

                productTypes.empty()
                    .append($('<table>')
                        .prop('id', 'show-types-table')
                        .addClass('table table-striped table-hover')
                        .append($('<tbody>')
                            .append($('<tr>')
                                .append($('<td>').text('Name'))
                                .append($('<td>').text('Delete'))
                            )));
                for (var index in types) {
                    $('#show-types-table')
                        .append($('<tr>')
                            .append($('<td>')
                                .text(types[index].name))
                            .append($('<td>')
                                .append($('<a>')
                                    .addClass('delete-type')
                                    .prop('id', types[index].product_ID)
                                    .append($('<img>')
                                        .prop('src', 'images/delete.png')))
                            ));

                }
                $('#change-types-button').text('Add new type');
                $('#add-type').attr('disabled', 'disabled');
            })
            .catch(function () {
                alert('Error');
            })
    }

    $(document).on('click', 'a.delete-type', function () {
        console.log(this);
        var idType = $(this).attr('id');
        $.post('delete_type.php', {
            action: 'delete',
            id: idType
        })
            .then(function () {
                showTypes();
            })
            .catch(function () {
                alert("Delete type failed!");
            })

    });

    $('#change-types-button').on('click', function () {
        var valueOfButton = $('#change-types-button');
        if (valueOfButton.text() === 'Show types') {
            showTypes();
        }
        if (valueOfButton.text() === 'Add new type') {
            addNewType();
        }
    });

    function addNewType() {
        var productTypes = $('#div-show-types');
        productTypes.empty()
            .append($('<label>')
                .text('Name'))
            .append($('<input>')
                .attr('id', 'type-name')
                .addClass('form-control')
                .attr('type', 'text')
            );
        $('#change-types-button').text('Show types');
        $('#add-type').removeAttr('disabled');
    }

    $('#add-new-type').on('click', function () {
        addNewType();
    });

    function showClients() {
        $.get('client.php', {
            action: 'clients'
        })
            .then(function (response) {
                $("#display-records-div")
                    .empty()
                    .append($('<button>')
                        .prop('type', 'button')
                        .addClass('btn btn-primary')
                        .attr('data-toggle', 'modal')
                        .attr('data-target', '#add-client-modal')
                        .text('Add client'))
                    .append($('<table>')
                        .attr('id', 'clients-table')
                        .addClass('table')
                        .addClass('table-hover')
                        .append($('<tbody>')
                            .append(($('<tr>')
                                    .append($('<td>').text('ID'))
                                    .append($('<td>').text('Name'))
                                    .append($('<td>').text('Age'))
                                    .append($('<td>').text('Purchase price'))
                            ))
                        )
                    );

                var clients = JSON.parse(response).clients;

                for (var index in clients) {
                    $("#clients-table").append(
                        $('<tr>')
                            .append($('<td>').text(clients[index].clientID))
                            .append($('<td>').text(clients[index].name))
                            .append($('<td>').text(clients[index].age))
                            .append($('<td>').text(clients[index].purchase_price))
                    );
                }
            })
            .catch(function () {
                alert('Error');
            })
    }

    function showProducts() {
        $.get('product.php', {
            action: 'products'
        })
            .then(function (response) {
                loadTypesOfProducts();

                $("#display-records-div")
                    .empty()
                    .append($('<button>')
                        .addClass('btn btn-primary')
                        .prop('type', 'button')
                        .attr('data-toggle', 'modal')
                        .attr('data-target', '#add-product-modal')
                        .text('Add product'))
                    .append($('<button>')
                        .attr('id', 'product-type-change')
                        .addClass('btn')
                        .prop('type', 'button')
                        .text('Change types of products')
                        .attr('data-toggle', 'modal')
                        .attr('data-target', '#change-types'))
                    .append($('<table>')
                        .attr('id', 'products-table')
                        .addClass('table')
                        .addClass('table-hover')
                        .append($('<tbody>')
                            .append(($('<tr>')
                                    .append($('<td>').text('ID'))
                                    .append($('<td>').text('Name'))
                                    .append($('<td>').text('Type'))
                                    .append($('<td>').text('Price'))
                            ))
                        )
                    );

                var products = JSON.parse(response).products;

                for (var index in products) {
                    $('#products-table').append(
                        $('<tr>')
                            .append($('<td>').text(products[index].productID))
                            .append($('<td>').text(products[index].name))
                            .append($('<td>').text(products[index].type))
                            .append($('<td>').text(products[index].price))
                    );
                }
            })
            .catch(function () {
                alert('Error');
            })
    }

    $("#show-products").click(function () {
        showProducts();
    });
</script>
</body>
</html>